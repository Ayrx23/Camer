<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gesture Particles Stable</title>
<style>
body{margin:0;background:black;overflow:hidden}
#video{position:fixed;bottom:10px;left:10px;width:160px;height:120px;
border:2px solid cyan;border-radius:8px;transform:scaleX(-1);opacity:.85}
#label{position:fixed;top:10px;right:20px;color:#0ff;font-family:monospace}
</style>
</head>
<body>

<div id="label">Loading…</div>
<video id="video" autoplay muted playsinline></video>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ---------- THREE ---------- */
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,1000);
camera.position.z=120;

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
document.body.appendChild(renderer.domElement);

/* ---------- PARTICLES ---------- */
const COUNT=12000;
const pos=new Float32Array(COUNT*3);
const col=new Float32Array(COUNT*3);

const geo=new THREE.BufferGeometry();
geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
geo.setAttribute('color',new THREE.BufferAttribute(col,3));

const mat=new THREE.PointsMaterial({
  size:1,
  vertexColors:true,
  blending:THREE.AdditiveBlending,
  transparent:true,
  depthWrite:false
});

const pts=new THREE.Points(geo,mat);
scene.add(pts);

/* ---------- SHAPES ---------- */
const shapes=['cloud','heart','ring','spiral'];
let shapeIndex=0;
let solar=false;

function setShape(type){
  for(let i=0;i<COUNT;i++){
    const i3=i*3;
    let x=0,y=0,z=0,r=1,g=1,b=1;

    if(type==='cloud'){
      const a=Math.random()*Math.PI*2;
      const d=Math.random()*50;
      x=Math.cos(a)*d; y=Math.sin(a)*d; z=(Math.random()-.5)*30;
      r=0.2; g=0.8; b=1;
    }

    if(type==='heart'){
      const t=Math.random()*Math.PI*2;
      x=16*Math.pow(Math.sin(t),3);
      y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);
      z=(Math.random()-.5)*10;
      x*=2; y*=2;
      r=1; g=0.2; b=0.4;
    }

    if(type==='ring'){
      const a=Math.random()*Math.PI*2;
      const r2=40+Math.random()*10;
      x=Math.cos(a)*r2; z=Math.sin(a)*r2; y=(Math.random()-.5)*4;
      r=1; g=0.8; b=0.2;
    }

    if(type==='spiral'){
      const t=i*0.02;
      x=Math.cos(t)*t;
      z=Math.sin(t)*t;
      y=(i/COUNT-.5)*80;
      r=Math.sin(t)*.5+.5;
      g=Math.cos(t)*.5+.5;
      b=1;
    }

    pos[i3]=x; pos[i3+1]=y; pos[i3+2]=z;
    col[i3]=r; col[i3+1]=g; col[i3+2]=b;
  }
  geo.attributes.position.needsUpdate=true;
  geo.attributes.color.needsUpdate=true;
  label.textContent='Mode: '+type;
}

function setSolar(){
  for(let i=0;i<COUNT;i++){
    const a=Math.random()*Math.PI*2;
    const r2=(i%6)*15;
    pos[i*3]=Math.cos(a)*r2;
    pos[i*3+1]=(Math.random()-.5)*2;
    pos[i*3+2]=Math.sin(a)*r2;
    col[i*3]=1; col[i*3+1]=1; col[i*3+2]=0;
  }
  geo.attributes.position.needsUpdate=true;
  geo.attributes.color.needsUpdate=true;
  label.textContent='Mode: Solar System';
}

setShape('cloud');

/* ---------- HAND TRACKING ---------- */
const video=document.getElementById('video');
const label=document.getElementById('label');

let pinch=0.3;
let lastSwitch=0;
let lastClap=0;

const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  maxNumHands:2,
  minDetectionConfidence:.6,
  minTrackingConfidence:.6
});

hands.onResults(res=>{
  if(!res.multiHandLandmarks) return;

  // ONE HAND → pinch scale + shape switch
  if(res.multiHandLandmarks.length===1){
    const lm=res.multiHandLandmarks[0];
    pinch=Math.hypot(lm[4].x-lm[8].x,lm[4].y-lm[8].y);

    if(pinch<0.05 && performance.now()-lastSwitch>1200){
      shapeIndex=(shapeIndex+1)%shapes.length;
      setShape(shapes[shapeIndex]);
      lastSwitch=performance.now();
    }
  }

  // TWO HANDS → clap toggle
  if(res.multiHandLandmarks.length===2){
    const a=res.multiHandLandmarks[0][9];
    const b=res.multiHandLandmarks[1][9];
    const d=Math.hypot(a.x-b.x,a.y-b.y);

    if(d<0.07 && performance.now()-lastClap>1500){
      solar=!solar;
      solar?setSolar():setShape(shapes[shapeIndex]);
      lastClap=performance.now();
    }
  }
});

new Camera(video,{
  onFrame:async()=>hands.send({image:video}),
  width:640,height:480
}).start();

/* ---------- LOOP ---------- */
function animate(){
  requestAnimationFrame(animate);

  const safe=Math.max(pinch,0.08);
  const s=THREE.MathUtils.lerp(pts.scale.x,1/safe,0.1);
  pts.scale.setScalar(THREE.MathUtils.clamp(s,0.6,3));

  pts.rotation.y+=0.002;
  pts.rotation.x+=0.001;

  renderer.render(scene,camera);
}
animate();

addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>

